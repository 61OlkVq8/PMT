# SLOWCOACH

> Remember, a few hours of trial and error can save you several minutes of looking at the README.

## Introduction
`SlowCoach` is a code mutation tool for C/C++ programs that attempts to create variants of these programs with reduced performance.
`SlowCoach` uses libclang to match the abstract syntax tree generated by the clang parser and to rewrite the source code text.
Each mutant is a source file whose matched parts are modified to simulate performance bugs during development.

## Quick setup

The first step is to initialize the project by the `bootstrap` script.
SlowCoach comes with a docker file which instantiates a docker image providing all necessary tools needed to build the SlowCoach tool and carry out evaluations.
A simple command `docker build $(SLOWCOACH_PATH)` creates an anonymous image with the development environment ready for use.
Users can apply their own names or tags into the `docker build` command, e.g., `docker build -t SlowCoach:stable $(SLOWCOACH_PATH)` which creates an image named "SlowCoach" with the "stable" tag.
The building process is slow because the clang tool chain is built ad hoc due to the missing rtti information in the official clang/llvm binary.
Also, the size of the image is quite large due to the "layers" created by the long list of operations in the Dockerfile.
If experimental features are enabled for docker, i.e.
```json
{
	"experimental": true
}
```
in `/etc/docker/daemon.json`, the `--squash` option can be applied when building image to remedy that issue, e.g.,
```bash
docker build --squash -t SlowCoach:stable $(SLOWCOACH_PATH)
```

It is recommended to build SlowCoach out of the tree, and as a practice of thumb, Dockerfile does not hardcode to copy all sources into the docker container, but leaves sources to be mounted (bind mounts) into the container.
Assume the Linux user is named `foo` and the SlowCoach is cloned at path `/home/foo/SlowCoach` and the building path is `/home/foo/SlowCoach_build`, following command mounts both souce and building directory to `/root/SlowCoach` and `/root/SlowCoach_build` inside the container respectively:
```bash
docker run -it --rm -v /home/foo/SlowCoach:/root/SlowCoach -v /home/foo/SlowCoach_build:/root/SlowCoach_build SlowCoach
```
Please be adviced that this command would automatically remove all changes applied to the container.
If you would like to keep your changes in the container, simply removing the `--rm` option.

Once inside the container, there should be three directories in `/root`:
```bash
/root/SlowCoach		# the source directory
/root/SlowCoach_build	# the building directory
/root/evaluation	# the projects for evaluation
```
Two steps are needed to build the complete project (can run in parallel):
1. Executing `bootstrap` script inside the source directory initializes the python environment.
2. Inside the building directory (`SlowCoach_build`), `cmake ../SlowCoach && make -j$(nproc)` builds the entire project.
Moreover, it is recommended to apply `-DCMAKE_EXPORT_COMPILE_COMMANDS=True` to `cmake` for the compilation database which is useful for autocompletion tools like [YouCompleteMe](https://github.com/ycm-core/YouCompleteMe).

Once `echo $?` returns 0 after all these steps, congratulations that `SlowCoach` is ready to make other programs slow!

## Usage

### Laconic version
Since the execution of `SlowCoach` is notoriously long and repetitive, a python script is provided at `SlowCoach/scripts`.
As a rule of thumb in python, it is always a good idea to create a virtual environment:
```bash
cd SlowCoach/scripts && virtualenv -p /usr/bin/python3 ./venv
source ./venv/bin/activate
pip install -r ./install.txt
```
These have been setup by the Dockerfile already.
Please `source` the activate file everytime starting a container from the image.
As an example, we have a `grep` project at `~/root/evaluation/grep/` and we need to build it manually with the `bear` tool (also available in the docker image) like `evaluation/grep/configure && bear make -j $(nproc)`.
A `compile_commands.json` is generated by `bear` in the `grep` directory.
By running the script `mutate.py` fed by the complilation json file like:
```bash
python ./mutate.py -l --header ~/root/evaluation/grep/compile_commands.json
```
All mutants are generated at the same directory with the source code, which is a directory whose name is derived from the original source file name, e.g. `main.cpp -> main_cpp/`, where `main_cpp/` contains all mutants.

Please consult `python ./__init__.py -h` for details in concrete usage.
Finally, don't forget to `deactive` the virtual environment when `SlowCoach` is no longer needed and activate the environment when we want to run `SlowCoach` again or the user logout the current shell session (including quit the terminal in GUI).

### Type monkey version
For those who are not contended by leaving scripts handling every detail, here's the brief introduction how python script works.
Naively, the usage could be as simple as:
```bash
cd $(PWD)/SlowCoach_build
./SlowCoach ../SlowCoach/main.cpp
```
And theoretically there should be a `$(PWD)/SlowCoach/main_cpp` folder generated.
But the mutation won't work because:
1. The clang frontend in `SlowCoach` needs to know how this file is compiled, with all the arguments passed to the compiler, e.g. all including paths and library paths
2. The `clang` tooling, on which `SlowCoach` is based, needs extra headers to build the AST.
The first problem is solved by exporting the _compilation database_, which is intuitively available with `cmake` when specifying `-DCMAKE_EXPORT_COMPILE_COMMANDS=True` when building the target project.
For GNU compatible projects, the `bear` tool (see [here](https://github.com/rizsotto/Bear), also available on a lot of package repositories like the one from ubuntu) is a good option that intercepts the make commands.
Once the `compilation_database.json` appears at the build directory, simply feed it with the `-p` option.
The second problem needs the path of `/usr/lib/clang/$(VERSION)/include/` to be added to the compilation parameters, where `$(VERSION)` is 8.x or 9.x in our case.

Summing up the previous two problems, we need to build `SlowCoach` like:
```bash
cd $(PWD)/SlowCoach_build
cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=True ../SlowCoach && make
```
And run it:
```bash
./SlowCoach --extra-arg='-I/usr/lib/clang/$(VERSION)/include/' \
-p ./compilation_database.json ../SlowCoach/main.cpp
```

## Manual install
For those who had problems building within the docker container (though unlikely), manual installation repeating steps in the Dockerfile could be applied.
A possibly incomplete list of prerequisites:
* A C/C++ compiler (`gcc`/`icc`/`clang`)
* `cmake`
* `git` (optional)
* `virtualenv` (optional, for python scripts)

Most Linux distribution use package managers via which these tools are provided.

Once all needed software are installed, the first step is to get the source code of `SlowCoach` and `llvm` tools
```bash
git clone https://github.com/xiaoming-chen-zuishuai/SlowCoach
git clone https://github.com/llvm/llvm-project
```
Assume the current working direcotry where `SlowCoach` and `llvm-projct` source code dwell is `$(PWD)` (substituting this with the real path).
First step is to build a working `llvm`/`clang` toolchain.
Currently `SlowCoach` is only tested on `clang 8.0` and `clang 9.0`.
So please make sure the git branch is reset to the tag of 8.x or 9.x release (the version matters here due to contantly changing `clang` internal programming interfaces).
The [official manual](https://clang.llvm.org/get_started.html) of `llvm`/`clang` provides an authentic guide on the building process.
Like other `cmake` projects, `SlowCoach` also prefers out-of-tree building:
```bash
cd $(PWD) && mkdir SlowCoach_build
cd ./SlowCoach_build
cmake ../SlowCoach && make
```
The last commands specifies how SlowCoach should be built.
Currently only debug/release options are implemented.
